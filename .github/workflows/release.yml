name: Release API

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Build production bundle
        run: npm run build --if-present

      - name: Compute release tag
        id: version
        run: echo "tag=v$(date +'%Y.%m.%d')-${GITHUB_RUN_NUMBER}" >> "$GITHUB_OUTPUT"

      - name: Prepare release archive
        run: |
          mkdir -p release
          cp -r dist release/
          cp package.json release/
          [ -f package-lock.json ] && cp package-lock.json release/
          cp tsconfig.json release/ || true
          tar -czf pressiqo-land-${{ steps.version.outputs.tag }}.tar.gz -C release .

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: pressiqo-land-${{ steps.version.outputs.tag }}
          path: pressiqo-land-${{ steps.version.outputs.tag }}.tar.gz
          retention-days: 14

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: pressiqo.app ${{ steps.version.outputs.tag }}
          body: |
            Automated release for pressiqo.app
            - Commit: ${{ github.sha }}
            - Build: ${{ github.run_id }}
          files: |
            pressiqo-land-${{ steps.version.outputs.tag }}.tar.gz
